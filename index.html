<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AES Pro</title>
    <style>
        :root {
            --bg: #f3f2f1;
            --fg: #201f1e;
            --accent: #0078d4;
            --accent-dark: #005a9e;
            --danger: #d13438;
            --success: #107c10;
            --muted: #605e5c;
            --border: #d2d0ce;
            --card: #ffffff;
            --overlay: rgba(0, 0, 0, 0.85);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: var(--fg);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow-x: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* 初始化/清空进度屏 */
        .init-screen {
            position: fixed;
            inset: 0;
            background: var(--overlay);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s, visibility 0.4s;
        }

        .init-screen.active { opacity: 1; visibility: visible; }

        .init-content {
            width: 85%;
            max-width: 400px;
            text-align: center;
        }

        .init-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1.5rem;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .init-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .init-status {
            font-size: 0.875rem;
            opacity: 0.7;
            margin-bottom: 2rem;
            min-height: 1.2em;
        }

        .progress-track {
            height: 2px;
            background: rgba(255,255,255,0.2);
            border-radius: 1px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #fff;
            width: 0%;
            transition: width 0.2s linear;
        }

        /* 通知提示框 */
        .notice-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            width: 90%;
            max-width: 360px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notice {
            background: var(--fg);
            color: #fff;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.9375rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
        }

        .notice.show { opacity: 1; transform: translateY(0); }
        .notice.success { background: var(--success); }
        .notice.error { background: var(--danger); }
        .notice svg { width: 20px; height: 20px; flex-shrink: 0; }

        /* 确认弹窗 */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-box {
            background: var(--card);
            width: 100%;
            max-width: 320px;
            border-radius: 8px;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .modal-overlay.active .modal-box { transform: scale(1); }

        .modal-body {
            padding: 1.5rem;
            text-align: center;
        }

        .modal-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; }
        .modal-text { font-size: 0.875rem; color: var(--muted); line-height: 1.5; }

        .modal-actions {
            display: flex;
            border-top: 1px solid var(--border);
        }

        .modal-btn {
            flex: 1;
            padding: 0.875rem;
            border: none;
            background: none;
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--accent);
            cursor: pointer;
            outline: none;
        }

        .modal-btn:active { background: var(--bg); }
        .modal-btn.danger { color: var(--danger); }
        .modal-btn:not(:last-child) { border-right: 1px solid var(--border); }

        /* 主布局 */
        .app {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            background: var(--card);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .brand svg { width: 20px; height: 20px; }

        .status-badge {
            font-size: 0.6875rem;
            padding: 0.2rem 0.5rem;
            background: var(--success);
            color: #fff;
            border-radius: 2px;
            font-weight: 600;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0;
        }

        @media (min-width: 900px) {
            .grid { grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); }
        }

        .panel {
            background: var(--card);
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .panel-header {
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .panel-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.125rem; }
        .panel-sub { font-size: 0.75rem; color: var(--muted); }

        /* 表单元素 */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1.25rem;
        }

        .tab {
            padding: 0.625rem 0;
            flex: 1;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--muted);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .field { margin-bottom: 1rem; }

        .label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 0.375rem;
            display: flex;
            justify-content: space-between;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .label-badge {
            font-size: 0.625rem;
            padding: 0.1rem 0.3rem;
            background: var(--accent);
            color: #fff;
            border-radius: 2px;
            text-transform: none;
            letter-spacing: 0;
        }

        .label-badge.warn { background: #ffb900; color: #000; }

        input, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            background: var(--bg);
            font-family: inherit;
            font-size: 16px; /* 防止iOS缩放 */
            color: var(--fg);
            border-radius: 4px;
            transition: border-color 0.2s;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            line-height: 1.5;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 600px) {
            .row { grid-template-columns: 1fr 1fr; }
        }

        .btn {
            padding: 0.875rem 1rem;
            font-size: 0.9375rem;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.15s;
            font-family: inherit;
        }

        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; pointer-events: none; }

        .btn-primary { background: var(--accent); color: #fff; }
        .btn-primary:active { background: var(--accent-dark); }
        
        .btn-danger { background: var(--danger); color: #fff; }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--fg);
        }
        .btn-outline:active { background: var(--bg); }

        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: auto;
            padding-top: 1rem;
        }

        .result-box {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-top: 1rem;
            position: relative;
        }

        .result-content {
            padding: 0.75rem;
            font-family: "Consolas", monospace;
            font-size: 0.8125rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            min-height: 60px;
            max-height: 120px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .result-box.empty .result-content { color: var(--muted); font-style: italic; }

        .result-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-top: 1px solid var(--border);
            background: var(--card);
        }

        .result-meta { font-size: 0.6875rem; color: var(--muted); }
        
        .btn-sm {
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
        }

        /* 智能提示条 */
        .info-strip {
            background: #e1f5fe;
            padding: 0.625rem 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.75rem;
            color: #01579b;
            border-left: 3px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 4px 4px 0;
        }

        .info-strip.hidden { display: none; }

        .upload-area {
            border: 1px dashed var(--border);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .upload-area:active { background: var(--bg); border-color: var(--accent); }
        .upload-area.loaded { border-style: solid; border-color: var(--success); background: #e5f5e5; }

        .upload-icon { width: 24px; height: 24px; color: var(--muted); margin-bottom: 0.5rem; }
        .upload-text { font-size: 0.8125rem; color: var(--muted); }

        .strength-bar {
            height: 2px;
            background: var(--border);
            margin-top: 0.375rem;
            border-radius: 1px;
        }

        .strength-fill {
            height: 100%;
            transition: width 0.2s, background 0.2s;
        }

        .img-preview {
            margin-top: 0.75rem;
            text-align: center;
        }
        
        .img-preview img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 4px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="init-screen" id="initScreen">
    <div class="init-content">
        <div class="init-icon"></div>
        <div class="init-title" id="initTitle">正在初始化</div>
        <div class="init-status" id="initStatus">检查安全环境...</div>
        <div class="progress-track">
            <div class="progress-fill" id="initProgress"></div>
        </div>
    </div>
</div>

<div class="notice-container" id="noticeContainer"></div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-box">
        <div class="modal-body">
            <div class="modal-title" id="modalTitle">确认操作</div>
            <div class="modal-text" id="modalText">是否继续？</div>
        </div>
        <div class="modal-actions">
            <button class="modal-btn" id="modalCancel">取消</button>
            <button class="modal-btn danger" id="modalConfirm">确认</button>
        </div>
    </div>
</div>

<div class="app">
    <header>
        <div class="brand">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            AES Pro
        </div>
        <div class="status-badge">本地安全</div>
    </header>

    <div class="grid">
        <!-- 加密区 -->
        <div class="panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title">加密工具</div>
                    <div class="panel-sub">本地处理，数据不上传</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-mode="text">文本</button>
                <button class="tab" data-mode="dual">双瞳</button>
                <button class="tab" data-mode="image">图片</button>
            </div>

            <div id="modeText">
                <div class="field">
                    <div class="label"><span>明文内容</span><span id="countSrc">0 字符</span></div>
                    <textarea id="srcText" placeholder="输入要加密的内容..."></textarea>
                </div>
            </div>

            <div id="modeDual" class="hidden">
                <div class="info-strip">
                    <span>双瞳模式：密码A加密内容A，密码B加密内容B</span>
                </div>
                <div class="field">
                    <div class="label"><span>内容 A</span><span class="label-badge">密码A</span></div>
                    <textarea id="srcA" placeholder="第一段内容..."></textarea>
                </div>
                <div class="field">
                    <div class="label"><span>内容 B</span><span class="label-badge warn">密码B</span></div>
                    <textarea id="srcB" placeholder="第二段内容..."></textarea>
                </div>
            </div>

            <div id="modeImage" class="hidden">
                <div class="field">
                    <div class="label">选择文件</div>
                    <div class="upload-area" id="uploadArea">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        <div class="upload-text" id="uploadText">点击选择图片</div>
                        <input type="file" id="fileInput" accept="image/*" hidden>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <div class="label"><span>密码 A</span><span id="strLabel"></span></div>
                    <input type="password" id="keyA" placeholder="输入主密码">
                    <div class="strength-bar"><div class="strength-fill" id="strFill"></div></div>
                </div>
                <div class="field hidden" id="fieldKeyB">
                    <div class="label"><span>密码 B</span><span class="label-badge warn">可选</span></div>
                    <input type="password" id="keyB" placeholder="输入第二密码">
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="btnEnc">加密</button>
                <button class="btn btn-outline" id="btnClearEnc">清空</button>
            </div>

            <div class="result-box empty" id="resEncBox">
                <div class="result-content" id="resEnc">加密结果将显示在这里</div>
                <div class="result-footer">
                    <span class="result-meta" id="metaEnc">等待操作</span>
                    <button class="btn btn-sm btn-outline hidden" id="btnCopyEnc">复制</button>
                </div>
            </div>
        </div>

        <!-- 解密区 -->
        <div class="panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title">解密工具</div>
                    <div class="panel-sub">自动识别算法</div>
                </div>
            </div>

            <div class="field">
                <div class="label"><span>密文内容</span><span id="countCipher">0 字符</span></div>
                <textarea id="cipherText" placeholder="粘贴密文..."></textarea>
            </div>

            <div class="info-strip hidden" id="detectStrip">
                <span>检测类型</span>
                <span id="detectType">--</span>
            </div>

            <div class="row">
                <div class="field">
                    <div class="label">密码 A</div>
                    <input type="password" id="decKeyA" placeholder="输入密码">
                </div>
                <div class="field hidden" id="fieldDecB">
                    <div class="label"><span>密码 B</span><span class="label-badge warn">解密内容B</span></div>
                    <input type="password" id="decKeyB" placeholder="输入密码B">
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-danger" id="btnDec">解密</button>
                <button class="btn btn-outline" id="btnClearDec">清空</button>
            </div>

            <div class="result-box empty" id="resDecBox">
                <div class="result-content" id="resDec">解密结果将显示在这里</div>
                <div class="result-footer">
                    <span class="result-meta" id="metaDec">等待操作</span>
                    <button class="btn btn-sm btn-outline hidden" id="btnCopyDec">复制</button>
                </div>
            </div>

            <div class="img-preview hidden" id="imgPreview">
                <img id="decImg" src="" alt="">
                <a class="btn btn-sm btn-outline" id="btnDl" download="decrypted.jpg" style="margin-top:0.5rem;">下载图片</a>
            </div>
        </div>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);
    
    const ui = {
        init: $('initScreen'), title: $('initTitle'), status: $('initStatus'), progress: $('initProgress'),
        notice: $('noticeContainer'),
        modal: $('modalOverlay'), mTitle: $('modalTitle'), mText: $('modalText'), mCancel: $('modalCancel'), mConfirm: $('modalConfirm'),
        srcText: $('srcText'), srcA: $('srcA'), srcB: $('srcB'), keyA: $('keyA'), keyB: $('keyB'), fieldKeyB: $('fieldKeyB'),
        strFill: $('strFill'), strLabel: $('strLabel'), countSrc: $('countSrc'),
        upload: $('uploadArea'), uploadText: $('uploadText'), fileInput: $('fileInput'),
        resEnc: $('resEnc'), resEncBox: $('resEncBox'), metaEnc: $('metaEnc'), btnCopyEnc: $('btnCopyEnc'),
        cipher: $('cipherText'), decKeyA: $('decKeyA'), decKeyB: $('decKeyB'), fieldDecB: $('fieldDecB'),
        detectStrip: $('detectStrip'), detectType: $('detectType'), countCipher: $('countCipher'),
        resDec: $('resDec'), resDecBox: $('resDecBox'), metaDec: $('metaDec'), btnCopyDec: $('btnCopyDec'),
        imgPrev: $('imgPreview'), decImg: $('decImg'), btnDl: $('btnDl')
    };

    let mode = 'text';
    let fileData = null;
    let modalCb = null;

    // --- 通知系统 (自建) ---
    function notice(text, type = 'info') {
        const icons = {
            success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>',
            error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>',
            info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4m0 4h.01"/></svg>'
        };
        const div = document.createElement('div');
        div.className = `notice ${type}`;
        div.innerHTML = `${icons[type] || icons.info}<span>${text}</span>`;
        ui.notice.appendChild(div);
        
        // 触发重绘
        void div.offsetHeight;
        div.classList.add('show');

        setTimeout(() => {
            div.classList.remove('show');
            setTimeout(() => div.remove(), 300);
        }, 3000);
    }

    // --- 模态框系统 ---
    function showModal(title, text, cb) {
        ui.mTitle.textContent = title;
        ui.mText.textContent = text;
        modalCb = cb;
        ui.modal.classList.add('active');
    }

    ui.mCancel.onclick = () => ui.modal.classList.remove('active');
    ui.mConfirm.onclick = () => { if (modalCb) modalCb(); ui.modal.classList.remove('active'); };

    // --- 初始化/清空进度系统 ---
    function runInitSequence(title = "正在初始化", statusPrefix = "检查", onComplete = null) {
        ui.init.classList.add('active');
        ui.title.textContent = title;
        ui.progress.style.width = '0%';
        
        const duration = 10000 + Math.random() * 3000; // 10-13秒
        const start = Date.now();
        const steps = [
            { t: 0, s: "安全环境" },
            { t: 0.2, s: "浏览器接口" },
            { t: 0.4, s: "加密模块" },
            { t: 0.6, s: "内存清理" },
            { t: 0.8, s: "用户界面" },
            { t: 0.95, s: "就绪" }
        ];

        function update() {
            const elapsed = Date.now() - start;
            const p = Math.min(1, elapsed / duration);
            
            let curr = steps[0].s;
            for (let i = steps.length - 1; i >= 0; i--) {
                if (p >= steps[i].t) { curr = steps[i].s; break; }
            }
            
            ui.status.textContent = `${statusPrefix}${curr}...`;
            ui.progress.style.width = (p * 100) + '%';

            if (p < 1) {
                requestAnimationFrame(update);
            } else {
                setTimeout(() => {
                    ui.init.classList.remove('active');
                    if (onComplete) onComplete();
                    notice('操作完成', 'success');
                }, 300);
            }
        }
        requestAnimationFrame(update);
    }

    // --- 核心逻辑 ---
    const show = e => e && e.classList.remove('hidden');
    const hide = e => e && e.classList.add('hidden');

    function strength(v) {
        let s = 0;
        if (v.length >= 8) s++;
        if (v.length >= 12) s++;
        if (/[A-Z]/.test(v)) s++;
        if (/[0-9]/.test(v)) s++;
        if (/[^A-Za-z0-9]/.test(v)) s++;
        return Math.min(5, Math.max(0, s));
    }

    ui.keyA.oninput = () => {
        const s = strength(ui.keyA.value);
        ui.strFill.style.width = (s / 5 * 100) + '%';
        const colors = ['#d13438', '#d13438', '#ffb900', '#ffb900', '#107c10', '#107c10'];
        ui.strFill.style.background = colors[s];
        const labels = ['', '极弱', '弱', '一般', '强', '极强'];
        ui.strLabel.textContent = labels[s];
    };

    ui.srcText.oninput = () => ui.countSrc.textContent = ui.srcText.value.length + ' 字符';
    ui.cipher.oninput = () => {
        const v = ui.cipher.value.trim();
        ui.countCipher.textContent = v.length + ' 字符';
        if (v) {
            const t = detect(v);
            ui.detectType.textContent = t;
            show(ui.detectStrip);
            if (v.startsWith('DUAL:')) show(ui.fieldDecB); else hide(ui.fieldDecB);
        } else {
            hide(ui.detectStrip);
            hide(ui.fieldDecB);
        }
    };

    document.querySelectorAll('.tab').forEach(t => {
        t.onclick = () => {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            mode = t.dataset.mode;
            hide($('modeText')); hide($('modeDual')); hide($('modeImage')); hide(ui.fieldKeyB);
            if (mode === 'text') show($('modeText'));
            if (mode === 'dual') { show($('modeDual')); show(ui.fieldKeyB); }
            if (mode === 'image') show($('modeImage'));
        };
    });

    ui.upload.onclick = () => ui.fileInput.click();
    ui.fileInput.onchange = e => {
        const f = e.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = ev => {
            fileData = ev.target.result.split(',')[1];
            ui.uploadText.textContent = f.name;
            ui.upload.classList.add('loaded');
        };
        r.readAsDataURL(f);
    };

    async function derive(pw, salt, algo) {
        const enc = new TextEncoder();
        const key = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
        const name = algo === 'CTR' ? 'AES-CTR' : algo === 'CBC' ? 'AES-CBC' : 'AES-GCM';
        const len = algo === 'CTR' ? 128 : 256;
        return crypto.subtle.deriveKey({ name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' }, key, { name, length: len }, false, ['encrypt', 'decrypt']);
    }

    async function enc(data, pw, algo = 'GCM') {
        const enc = new TextEncoder();
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const ivLen = algo === 'GCM' ? 12 : 16;
        const iv = crypto.getRandomValues(new Uint8Array(ivLen));
        const key = await derive(pw, salt, algo);
        const name = algo === 'CTR' ? 'AES-CTR' : algo === 'CBC' ? 'AES-CBC' : 'AES-GCM';
        const param = algo === 'CTR' ? { name, counter: iv, length: 64 } : { name, iv };
        const cipher = await crypto.subtle.encrypt(param, key, enc.encode(data));
        const buf = new Uint8Array(salt.length + iv.length + cipher.byteLength);
        buf.set(salt, 0); buf.set(iv, salt.length); buf.set(new Uint8Array(cipher), salt.length + iv.length);
        return 'AES' + algo + btoa(String.fromCharCode(...buf));
    }

    async function dec(data, pw) {
        let algo = 'GCM';
        if (data.startsWith('AESCTR')) { algo = 'CTR'; data = data.slice(6); }
        else if (data.startsWith('AESCBC')) { algo = 'CBC'; data = data.slice(6); }
        else if (data.startsWith('AESGCM')) { algo = 'GCM'; data = data.slice(6); }
        const buf = new Uint8Array(atob(data).split('').map(c => c.charCodeAt(0)));
        const salt = buf.slice(0, 16);
        const ivLen = algo === 'GCM' ? 12 : 16;
        const iv = buf.slice(16, 16 + ivLen);
        const cipher = buf.slice(16 + ivLen);
        const key = await derive(pw, salt, algo);
        const name = algo === 'CTR' ? 'AES-CTR' : algo === 'CBC' ? 'AES-CBC' : 'AES-GCM';
        const param = algo === 'CTR' ? { name, counter: iv, length: 64 } : { name, iv };
        const dec = await crypto.subtle.decrypt(param, key, cipher);
        return { text: new TextDecoder().decode(dec), algo };
    }

    function detect(d) {
        if (d.startsWith('DUAL:')) return '双瞳加密';
        if (d.startsWith('IMG:')) return '图片加密';
        if (d.startsWith('AESCTR')) return 'AES-128-CTR';
        if (d.startsWith('AESCBC')) return 'AES-256-CBC';
        if (d.startsWith('AESGCM')) return 'AES-256-GCM';
        return '未知格式';
    }

    $('btnEnc').onclick = async () => {
        const ka = ui.keyA.value;
        if (!ka) return notice('请输入密码', 'error');
        $('btnEnc').disabled = true;
        ui.metaEnc.textContent = '加密中...';
        
        try {
            let out = '';
            if (mode === 'text') {
                const t = ui.srcText.value; if (!t) throw '请输入内容';
                out = await enc(t, ka, 'GCM');
            } else if (mode === 'dual') {
                const ta = ui.srcA.value, tb = ui.srcB.value, kb = ui.keyB.value;
                if (!ta && !tb) throw '请输入内容';
                const ea = ta ? await enc(ta, ka, 'GCM') : '';
                const eb = (tb && kb) ? await enc(tb, kb, 'CBC') : '';
                out = 'DUAL:' + ea + ':' + eb;
            } else if (mode === 'image') {
                if (!fileData) throw '请选择图片';
                out = 'IMG:' + await enc(fileData, ka, 'GCM');
            }
            ui.resEnc.textContent = out;
            ui.resEncBox.classList.remove('empty');
            ui.metaEnc.textContent = out.length + ' 字符';
            show(ui.btnCopyEnc);
            notice('加密完成', 'success');
        } catch (e) {
            notice('加密失败: ' + e, 'error');
            ui.metaEnc.textContent = '失败';
        }
        $('btnEnc').disabled = false;
    };

    $('btnDec').onclick = async () => {
        const src = ui.cipher.value.trim(), ka = ui.decKeyA.value;
        if (!src) return notice('请输入密文', 'error');
        if (!ka) return notice('请输入密码', 'error');
        $('btnDec').disabled = true;
        ui.metaDec.textContent = '解密中...';
        hide(ui.imgPrev);

        try {
            if (src.startsWith('IMG:')) {
                const { text: b64 } = await dec(src.slice(4), ka);
                ui.decImg.src = 'data:image/jpeg;base64,' + b64;
                ui.btnDl.href = ui.decImg.src;
                show(ui.imgPrev);
                ui.resDec.textContent = '[图片已解密]';
                ui.metaDec.textContent = '图片';
            } else if (src.startsWith('DUAL:')) {
                const parts = src.slice(5).split(':');
                let res = '';
                const kb = ui.decKeyB.value;
                if (parts[0]) {
                    try { res += '--- A ---\n' + (await dec(parts[0], ka)).text + '\n\n'; }
                    catch { res += '--- A ---\n[密码错误]\n\n'; }
                }
                if (parts[1]) {
                    if (kb) {
                        try { res += '--- B ---\n' + (await dec(parts[1], kb)).text; }
                        catch { res += '--- B ---\n[密码错误]'; }
                    } else { res += '--- B ---\n[需输入密码B]'; }
                }
                ui.resDec.textContent = res;
                ui.metaDec.textContent = '双瞳';
            } else {
                const { text, algo } = await dec(src, ka);
                ui.resDec.textContent = text;
                ui.metaDec.textContent = 'AES-256-' + algo;
                ui.detectType.textContent = 'AES-256-' + algo;
            }
            ui.resDecBox.classList.remove('empty');
            show(ui.btnCopyDec);
            notice('解密完成', 'success');
        } catch (e) {
            notice('解密失败: 密码错误或数据损坏', 'error');
            ui.metaDec.textContent = '失败';
        }
        $('btnDec').disabled = false;
    };

    // --- 清空按钮逻辑 (触发进度条) ---
    function resetAllData() {
        ui.srcText.value = ''; ui.srcA.value = ''; ui.srcB.value = '';
        ui.keyA.value = ''; ui.keyB.value = ''; ui.strFill.style.width = 0; ui.strLabel.textContent = '';
        ui.countSrc.textContent = '0 字符';
        ui.resEnc.textContent = '加密结果将显示在这里'; ui.resEncBox.classList.add('empty'); hide(ui.btnCopyEnc);
        ui.metaEnc.textContent = '等待操作';
        fileData = null; ui.uploadText.textContent = '点击选择图片'; ui.upload.classList.remove('loaded'); ui.fileInput.value = '';

        ui.cipher.value = ''; ui.decKeyA.value = ''; ui.decKeyB.value = '';
        ui.countCipher.textContent = '0 字符';
        ui.resDec.textContent = '解密结果将显示在这里'; ui.resDecBox.classList.add('empty'); hide(ui.btnCopyDec);
        ui.metaDec.textContent = '等待操作';
        hide(ui.detectStrip); hide(ui.fieldDecB); hide(ui.imgPrev);
    }

    $('btnClearEnc').onclick = () => showModal('清空确认', '确定要清空所有内容并重置环境吗？', () => {
        runInitSequence("正在清空", "清理", resetAllData);
    });

    $('btnClearDec').onclick = () => showModal('清空确认', '确定要清空所有内容并重置环境吗？', () => {
        runInitSequence("正在清空", "清理", resetAllData);
    });

    // --- 复制功能 ---
    ui.btnCopyEnc.onclick = async () => {
        try { await navigator.clipboard.writeText(ui.resEnc.textContent); notice('已复制', 'success'); }
        catch { notice('复制失败', 'error'); }
    };

    ui.btnCopyDec.onclick = async () => {
        try { await navigator.clipboard.writeText(ui.resDec.textContent); notice('已复制', 'success'); }
        catch { notice('复制失败', 'error'); }
    };

    // --- 启动 ---
    if (!window.crypto || !window.crypto.subtle) {
        notice('当前环境不支持安全加密', 'error');
    } else {
        runInitSequence();
    }
</script>
</body>
</html>
